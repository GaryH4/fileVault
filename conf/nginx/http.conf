worker_processes 4;

events {

  worker_connections 1024;
}

http {

  # Configuration containing list of application servers
  upstream filerun_server {
    server filerun:80;
  }

  upstream aria2_server {
    #if aria2 is using 'host' network mode, need to put server ip here
    #127.0.0.1 is not accessable 
    #cause' it's nginx container's lookback address here
    server <server_ip>:6800; 
  }

  upstream ariang_server {
    server ariang:6880;
  }

  server {

    listen 443 ssl http2;
    server_name <your_domain>;

    client_max_body_size 4G;

    #ssl
	  ssl on;
    ssl_certificate /etc/nginx/ssl/<your_domain>.cer; #set your own ssl cert files
    ssl_certificate_key /etc/nginx/ssl/<your_domain>.key; #but don't change the path
    ssl_dhparam /etc/nginx/ssl/dhparam.pem; #generated by openssl
    ssl_session_timeout 120m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;
    ssl_session_cache shared:SSL:10m;
    ssl_prefer_server_ciphers on;
    
    ssl_buffer_size 8k;

    ssl_stapling on;
    resolver 8.8.8.8;
    ssl_stapling_verify on;

    add_header Strict-Transport-Security max-age=31536000;

    access_log /var/log/nginx/ssl_access.log;
    error_log /var/log/nginx/ssl_error.log;

    # Handle Server Sent Events for Notifications
   
    # Proxy connections to the application servers
    #filerun
    location / {
      proxy_pass http://filerun_server;
      proxy_redirect off;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Host $server_name;
    }

    #aria2
    location /aria2/ { #forward slash here, important
      proxy_pass http://aria2_server/;
      proxy_redirect off;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Host $server_name;
    }

    #ariang
    location /ariang/ {
      proxy_pass http://ariang_server/;
      proxy_redirect off;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Host $server_name;
    }
  }
}
